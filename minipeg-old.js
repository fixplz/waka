function Minipeg(e,t){var n=[];var r;var i;var s=function(){return"_"+r++};var o=function(){for(var e=0;e<arguments.length;e++){n.push(arguments[e])}};var u=function(){o("(function(){var DOC,POS=0,SUCC=true,LASTPOS=0,ENDED,TRY=[],RES,MEMO={};");o('function ParseError(ctx,tried){this.pos=LASTPOS;this.tried=tried;this.repr="Parse error at "+LASTPOS+" in "+ctx+(tried?", tried "+tried:"")+"\\nLine:\\n"+DOC.slice(DOC.lastIndexOf("\\n",LASTPOS)+1,DOC.indexOf("\\n",LASTPOS))+"\\n"+Array(LASTPOS-DOC.lastIndexOf("\\n",LASTPOS)).join(" ")+"^"};ParseError.prototype.toString=function(){return this.repr};');o("function fail(ctx){throw {pfail:ctx}};");o("var RE=function(re){RES=re.exec(DOC.slice(POS));if(RES){LASTPOS=POS+=RES[0].length;/*TRY=[];*/return RES[0]}else{SUCC=false}};")};var a=function(){o("\n\nreturn function(doc,frag){ DOC=doc; for(k in parsers) MEMO[k]=[]; try{var r=frag?parsers[frag]():rule_",e.defs[0].name,'()}catch(err){throw(err.pfail?new ParseError(err.pfail,TRY):err)}; if(POS<DOC.length)throw new ParseError("root"); return r }');o("\n})()")};var f=function(e){o(e,"=")};var l=function(e,t){o(e,"=[];var ",e,"_i;");t.forEach?t.forEach(function(t){t.bind=e+"_i"}):t.bind=e+"_i"};var c=function(e){o(e,".push(",e,"_i);")};var h=function(e){if(e.bind&&!i[e.bind]&&!/_i$/.test(e.bind)){o("var ",e.bind,";");i[e.bind]=true}if(e.ref){if(e.bind)f(e.bind);o("rule_",e.ref,"();")}else if(e.re){if(e.bind)f(e.bind);o("RE(/^",e.re.replace(/\//g,"\\/"),"/);")}else if(e.str){h({re:e.str.replace(/([\]\[|()+*?.])/g,"\\$1"),bind:e.bind})}else if(e.seq){var t=s();o("var ",t,"=POS;");var n=null;if(e.seq[0].ctx)n=e.seq[0].ctx;else h(e.seq[0]);var r=s();o("\nif(SUCC){",r,":{");if(n)o("TRY=[];");e.seq.slice(1).forEach(function(e){if(e.ctx)n=e.ctx;else{h(e);if(!n)o("\nif(!SUCC)break ",r,";");else o('\nif(!SUCC)fail("',n,'");TRY=[];')}});o("\n}}if(!SUCC)POS=",t,";");if(e.bind){o("\nif(SUCC){");f(e.bind);o("DOC.slice(",t,",POS);}")}}else if(e.many){if(e.bind)l(e.bind,e.many);o("while(true){");h(e.many);o("\nif(!SUCC)break;");if(e.bind)c(e.bind);o("}SUCC=true;")}else if(e.many1){if(e.bind)l(e.bind,e.many1);h(e.many1);o("\nif(SUCC){");if(e.bind)c(e.bind);o("while(true){");h(e.many1);o("\nif(!SUCC)break;");if(e.bind)c(e.bind);o("}SUCC=true}")}else if(e.opt){e.opt.bind=e.bind;h(e.opt);o("if(!SUCC){");if(e.bind)o(e.bind,"=undefined;");o("SUCC=true}")}else if(e.alt){e.alt.slice(0,-1).forEach(function(e){if(e.opt||e.many)console.log("Warning:",e,"never fails but is used on the left side of /")});if(e.bind)e.alt.forEach(function(t){t.bind=e.bind});h(e.alt[0]);o("\nif(!SUCC){SUCC=true;");h(e.alt[1]);e.alt.slice(2).forEach(function(e){o("\n}if(!SUCC){SUCC=true;");h(e)});o("}")}else if(e.format){h(e.body);if(e.bind){o("\nif(SUCC)");f(e.bind);o(e.format,";")}}else if(e.look){var t=s();o("var ",t,"=POS;");o("try{");h(e.look);o("}catch(e){}");o("POS=",t,";")}else if(e.looknot){var t=s();o("var ",t,"=POS;");o("try{");h(e.looknot);o("}catch(e){}");o("POS=",t,";SUCC=!SUCC;")}else throw"Invalid AST "+JSON.stringify(e)};var p=function(n){i={RET:true};r=0;o("\n\nfunction rule_",n.name,"(){");o("var RET,ST=POS,M,N=rule_",n.name,".n;");if(t)o('console.log(">',n.name,':"+ST);');o("if(M=MEMO[N][POS]){SUCC=M.s;POS=M.p;return M.r};");o("TRY.push(N);");n.def.bind="RET";h(n.def);o("\n");if(t)o("console.log('<",n.name,":'+ST,'AT',POS, SUCC?RET:'FAIL');");o("MEMO[N][ST]={s:SUCC,p:POS,r:RET};");o("if(!SUCC)return;");if(n!=e.defs[0])o("if(ST<POS)ENDED=N;");o("return RET}")};if(typeof Parser!="undefined"&&typeof e=="string")e=Parser(e);console.log(require("util").inspect(e,false,10));u();if(e.init)o(e.init);e.defs.forEach(function(e){p(e)});o("\n\nvar parsers={");e.defs.forEach(function(e){o(e.name,":rule_",e.name,",")});o("};");o("for(k in parsers){ MEMO[k]=[]; parsers[k].n=k; }");a();return n.join("")}var Parser=function(){function a(t,n){this.pos=r;this.tried=n;this.repr="Parse error at "+r+" in "+t+(n?", tried "+n:"")+"\nLine:\n"+e.slice(e.lastIndexOf("\n",r)+1,e.indexOf("\n",r))+"\n"+Array(r-e.lastIndexOf("\n",r)).join(" ")+"^"}function f(e){throw{pfail:e}}function c(e,t,n){if(n){var r={};r[n=="?"?"opt":n=="+"?"many1":"many"]=t}else{var r=t}if(e)r.bind=e;return r}function h(){var e,r=t,i,o=h.n;if(i=u[o][t]){n=i.s;t=i.p;return i.r}s.push(o);var a=t;L();if(n){e:{var f=t;l(/^{/);if(n){t:{L();if(!n)break t;var c;c=g();if(!n)break t;l(/^}/);if(!n)break t;L();if(!n)break t}}if(!n)t=f;if(!n){n=true}if(!n)break e;var d;d=[];var v;v=p();if(n){d.push(v);while(true){v=p();if(!n)break;d.push(v)}n=true}if(!n)break e}}if(!n)t=a;if(n)e={defs:d,init:c};u[o][r]={s:n,p:t,r:e};if(!n)return;return e}function p(){var e,r=t,o,a=p.n;if(o=u[a][t]){n=o.s;t=o.p;return o.r}s.push(a);var f=t;var c;c=C();if(n){e:{L();if(!n)break e;l(/^=/);if(!n)break e;L();if(!n)break e;var h;h=d();if(!n)break e}}if(!n)t=f;if(n)e={name:c,def:h};u[a][r]={s:n,p:t,r:e};if(!n)return;if(r<t)i=a;return e}function d(){var e,r=t,o,a=d.n;if(o=u[a][t]){n=o.s;t=o.p;return o.r}s.push(a);var f=t;var c;c=v();if(n){e:{var h;h=[];var p;while(true){var m=t;l(/^\//);if(n){t:{L();if(!n)break t;var g;g=d();if(!n)break t}}if(!n)t=m;if(n)p=g;if(!n)break;h.push(p)}n=true;if(!n)break e}}if(!n)t=f;if(n)e=h.length>0?{alt:[c].concat(h)}:c;u[a][r]={s:n,p:t,r:e};if(!n)return;if(r<t)i=a;return e}function v(){var e,r=t,o,a=v.n;if(o=u[a][t]){n=o.s;t=o.p;return o.r}s.push(a);var f=t;var l;l=y();if(n){e:{var c;c=m();if(!n){c=undefined;n=true}if(!n)break e;L();if(!n)break e}}if(!n)t=f;if(n)e=c?{format:c,body:l}:l;u[a][r]={s:n,p:t,r:e};if(!n)return;if(r<t)i=a;return e}function m(){var e,r=t,o,a=m.n;if(o=u[a][t]){n=o.s;t=o.p;return o.r}s.push(a);var f=t;l(/^{/);if(n){e:{var c;c=g();if(!n)break e;l(/^}/);if(!n)break e}}if(!n)t=f;if(n)e=c;u[a][r]={s:n,p:t,r:e};if(!n)return;if(r<t)i=a;return e}function g(){var r,o=t,a,f=g.n;if(a=u[f][t]){n=a.s;t=a.p;return a.r}s.push(f);var c=t;l(/^[^{}]*/);if(n){e:{while(true){var h=t;l(/^{/);if(n){t:{g();if(!n)break t;l(/^}/);if(!n)break t;l(/^[^{}]*/);if(!n)break t}}if(!n)t=h;if(!n)break}n=true;if(!n)break e}}if(!n)t=c;if(n){r=e.slice(c,t)}u[f][o]={s:n,p:t,r:r};if(!n)return;if(o<t)i=f;return r}function y(){var e,r=t,o,a=y.n;if(o=u[a][t]){n=o.s;t=o.p;return o.r}s.push(a);var f;f=[];var l;while(true){l=b();if(!n)break;f.push(l)}n=true;if(n)e=f.length==1?f[0]:{seq:f};u[a][r]={s:n,p:t,r:e};if(!n)return;if(r<t)i=a;return e}function b(){var e,r=t,o,a=b.n;if(o=u[a][t]){n=o.s;t=o.p;return o.r}s.push(a);var f=t;E();if(n){e:{var h;var p=t;var d;d=C();if(n){t:{l(/^:/);if(!n)break t;L();if(!n)break t}}if(!n)t=p;if(n)h=d;if(!n){h=undefined;n=true}if(!n)break e;var v;v=S();if(!n){n=true;v=x();if(!n){n=true;v=T();if(!n){n=true;v=w()}}}if(!n)break e;L();if(!n)break e;var m;m=l(/^\?/);if(!n){n=true;m=l(/^\*/);if(!n){n=true;m=l(/^\+/)}}if(!n){m=undefined;n=true}if(!n)break e;L();if(!n)break e}}if(!n)t=f;if(n)e=c(h,v,m);if(!n){n=true;var g=t;l(/^%/);if(n){n:{var y;y=x();if(!n)break n;L();if(!n)break n}}if(!n)t=g;if(n)e={ctx:y};if(!n){n=true;var N=t;m=l(/^&/);if(!n){n=true;m=l(/^!/)}if(n){r:{v=b();if(!n)break r}}if(!n)t=N;if(n)e=m=="&"?{look:v}:{looknot:v}}}u[a][r]={s:n,p:t,r:e};if(!n)return;if(r<t)i=a;return e}function w(){var e,r=t,o,a=w.n;if(o=u[a][t]){n=o.s;t=o.p;return o.r}s.push(a);var f=t;l(/^\(/);if(n){e:{L();if(!n)break e;var c;c=d();if(!n)break e;l(/^\)/);if(!n)break e;L();if(!n)break e}}if(!n)t=f;if(n)e=c;u[a][r]={s:n,p:t,r:e};if(!n)return;if(r<t)i=a;return e}function E(){var e,r=t,o,a=E.n;if(o=u[a][t]){n=o.s;t=o.p;return o.r}s.push(a);var f=t;try{var c=t;C();if(n){e:{l(/^ *=/);if(!n)break e}}if(!n)t=c}catch(h){}t=f;n=!n;u[a][r]={s:n,p:t,r:e};if(!n)return;if(r<t)i=a;return e}function S(){var e,r=t,o,a=S.n;if(o=u[a][t]){n=o.s;t=o.p;return o.r}s.push(a);var f;f=C();if(n)e={ref:f};u[a][r]={s:n,p:t,r:e};if(!n)return;if(r<t)i=a;return e}function x(){var e,r=t,o,a=x.n;if(o=u[a][t]){n=o.s;t=o.p;return o.r}s.push(a);var f=t;l(/^\'/);if(n){e:{var c;c=l(/^(\\\\|\\'|[^'])*/);if(!n)break e;l(/^\'/);if(!n)break e}}if(!n)t=f;if(n)e={str:c};u[a][r]={s:n,p:t,r:e};if(!n)return;if(r<t)i=a;return e}function T(){var e,r=t,o,a=T.n;if(o=u[a][t]){n=o.s;t=o.p;return o.r}s.push(a);var f=t;l(/^\[/);if(n){e:{var c;c=N();if(!n)break e;l(/^\]/);if(!n)break e}}if(!n)t=f;if(n)e={re:c};u[a][r]={s:n,p:t,r:e};if(!n)return;if(r<t)i=a;return e}function N(){var r,o=t,a,f=N.n;if(a=u[f][t]){n=a.s;t=a.p;return a.r}s.push(f);var c=t;l(/^(\\(\[|\])|[^\[\]])*/);if(n){e:{while(true){var h=t;l(/^\[/);if(n){t:{l(/^(?:\\\]|[^\]])*/);if(!n)break t;l(/^\]/);if(!n)break t}}if(!n)t=h;if(!n)break}n=true;if(!n)break e;l(/^(\\\]|[^\]])*/);if(!n)break e}}if(!n)t=c;if(n){r=e.slice(c,t)}u[f][o]={s:n,p:t,r:r};if(!n)return;if(o<t)i=f;return r}function C(){var e,r=t,o,a=C.n;if(o=u[a][t]){n=o.s;t=o.p;return o.r}s.push(a);e=l(/^[a-zA-Z0-9_]+/);u[a][r]={s:n,p:t,r:e};if(!n)return;if(r<t)i=a;return e}function L(){var r,o=t,a,f=L.n;if(a=u[f][t]){n=a.s;t=a.p;return a.r}s.push(f);r=[];var c;while(true){c=l(/^[ \r\n]+/);if(!n){n=true;var h=t;l(/^\/\//);if(n){e:{l(/^[^\n]*\n/);if(!n)break e}}if(!n)t=h;if(n){c=e.slice(h,t)}}if(!n)break;r.push(c)}n=true;u[f][o]={s:n,p:t,r:r};if(!n)return;if(o<t)i=f;return r}var e,t=0,n=true,r=0,i,s=[],o,u={};a.prototype.toString=function(){return this.repr};var l=function(i){o=i.exec(e.slice(t));if(o){r=t+=o[0].length;return o[0]}else{n=false}};var A={start:h,rule:p,expr:d,expr_format:v,format:m,js:g,expr_seq:y,expr_atom:b,expr_parens:w,not_rule:E,ref:S,str:x,re:T,re_body:N,name:C,_:L};for(k in A){u[k]=[];A[k].n=k}return function(n,r){e=n;for(k in A)u[k]=[];try{var i=r?A[r]():h()}catch(o){throw o.pfail?new a(o.pfail,s):o}if(t<e.length)throw new a("root");return i}}();if(module)module.exports=Minipeg